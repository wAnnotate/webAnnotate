{% extends "main.html" %}
{% block content %}
<script defer>
    function generateDataTable(id,cols){
        $("#"+id).dataTable({
                  "orderable": false,
                  "columnDefs": [
                      {
                          "targets": cols,
                          "class":"none"
                      },
                      {
                          "orderable": false,
                          "aaSorting": false,
                          "targets": "_all",
                      },
                      {
                         "targets": [0],
                         "className": 'details-control',
                     }
                  ],
                  
                  "iDisplayLength": 2,
                  "aLengthMenu": [[2,5, 10, 25, 50, 100, -1], [2,5, 10, 25, 50, 100, "All"]],
                  "language": {
                      "paginate": {
                          "previous": "previous",
                          "next": "next"
                      }
                  },
                  responsive: true,
              })
    }

    function toNormalDataTable() {
        $("#table").dataTable({
             
        dom: 'lBfrtip',
             "orderable": false,
             
            buttons: [
            {
                extend: 'csv',
                exportOptions: {
                    columns: [ 1, 2, 3, 4,5,6,7,8,9,10,11,12,13 ]
                }
            },
            
            {
                extend: 'excel',
                exportOptions: {
                    columns: [ 1, 2, 3, 4,5,6,7,8,9,10,11,12,13 ]
                }
            },
            
            {
                extend: 'print',
                exportOptions: {
                    columns: [ 1, 2, 3, 4,5,6,7,8,9,10,11,12,13 ]
                }
            }
            ],
             "columnDefs": [
                 {
                     "targets": [11,12],
                     "class":"none"
                 },
                 {
                     "orderable": false,
                     "aaSorting": false,
                     "targets": "_all",
                 },
                 {
                    "targets": [0],
                    "className": 'details-control',
                }
             ],
             
             "iDisplayLength": 2,
             "aLengthMenu": [[2,5, 10, 25, 50, 100, -1], [2,5, 10, 25, 50, 100, "All"]],
             "language": {
                 "paginate": {
                     "previous": "previous",
                     "next": "next"
                 }
             },
			 responsive: true,
             initComplete: function () {
                 this
                    .api().order( [ 1, 'asc' ] )
                    .draw();
                 [...document.getElementsByTagName("button")]
                    .filter(b => b.getAttribute("name") != "+")
                    .forEach(b => b.className += " btn btn-outline-primary");
                 let count = 0;
                 let cols = [4,5,6,9]; 
                 this.api().columns(cols).every(function () {
                     var column = this;
                     var select = $(`<select id="select${count}"><option value=""></option></select>`)
                         .appendTo($("#s"+String(count++)))
                         .on('change', function () {
                             var val = $.fn.dataTable.util.escapeRegex($(this).val());
                             column.search(val ? '^' + val + '$' : '', true, false).draw();
                         });
                     column.data().unique().sort().each(d => {
                            select.append('<option value="' + d + '">' + d + '</option>');
                     });
                 });
             }
         })

    }
    setTimeout(()=>toNormalDataTable(),2000);
    function toggleFilter(){
        let filterB = document.getElementById("fltr");
        if(filterB.innerText.includes(">")){
            document.getElementById("filter").style.display = "block";
            filterB.innerText = "Filter V";
        }
        else{
            document.getElementById("filter").style.display = "none";
            filterB.innerText = "Filter >";
        }
    }
    function toggle(btn){
        if(btn.innerText == "-") btn.innerText = "+";
        else btn.innerText = "-";
    }

    window.addEventListener("load",() => {
        var span = document.getElementsByClassName("close")[0];
        var modal = document.getElementById("myModal");
        span.onclick = function() {
            modal.style.display = "none";
            [...document.getElementsByTagName("select")]
                .forEach(select => select.selectedIndex = 0);
            [...document.getElementsByClassName("page-link")]
                .forEach(l => l.setAttribute("style","z-index: 1"))
        }
        window.onclick = event => {
            if (event.target == modal) {
                modal.style.display = "none";
                [...document.getElementsByClassName("page-link")]
                    .forEach(l => l.setAttribute("style","z-index: 1"))
            }
        }
    })

    function showMyTab(tabButton){
        let id = tabButton.className.split(" ").pop();
        let tab = document.getElementById(id);
        [...document.getElementsByClassName("tab")]
            .forEach(tab => tab.style.display = "None");
        let cols = []
        if(id == "clinical"){
            for(let i = 10;i<tab.firstElementChild.getElementsByTagName("td").length;i++){
                cols.push(i);
            }
            if(tab.getAttribute("name") != "true"){
                tab.setAttribute("name","true");
                tab.firstElementChild.id = "variantTable";
                let td = document.createElement("td");
                let th = document.createElement("th");
                th.innerText = " ";
                tab.firstElementChild.firstElementChild.firstElementChild.prepend(th);
                td.innerHTML = `
                <button onclick="toggle(this)" style="color:white;font-size:20px;" name="+" class="btn btn-success btn-lg">
                +
                </button>
                `;
                [...tab.firstElementChild.getElementsByTagName("tr")]
                    .forEach(tr => tr.prepend(td));
                generateDataTable("variantTable",cols);
            }
        }
        tab.style.display = "block";
    }

    function createTab(name,data,display){
        let tab = document.createElement("div");
        tab.innerHTML = data;
        tab.style.display = display;
        tab.id = name;
        tab.className = "tab";
        if (tab.firstElementChild)
            [...tab.firstElementChild.getElementsByTagName("td")]
                .forEach(td => {
                    if(td.innerText.includes("https")){
                        td.innerHTML = `<a href="${td.innerText}">${td.innerText}</a>`;
                    }
                });
        return tab;
    }

    function toggleModal(select){
        if(!select.value)
            return;
        var gene = select.value.split("-")[0]
        var index = select.value.split("-")[1]
        var type = select.value.split("-")[2]
        var modal = document.getElementById("myModal");
        var modalHeader = document.getElementById("modalHeader");
        var modalBody = document.getElementById("modalBody");
        var tab_buttons = document.getElementById("tab_buttons");
        tab_buttons.innerHTML = ""
        fetch(`/getVariantData?gene=${gene}&variant=${index}&type=${type}`)
            .then(data => data.json())
            .then(data => {
                modalHeader.innerText = data["header"];
                if(type == "civic"){
                    let tab_names = ["general","clinical","assertions","groups","gene"];
                    modalBody.innerHTML = ""
                    for(let i =0;i<5;i++){
                        if(!data[tab_names[i]])
                            continue;
                        modalBody.append(
                            createTab(
                                tab_names[i],
                                data[tab_names[i]],
                                tab_names[i] == "general" ? "block" : "none" 
                            )
                        )
                        let button = document.createElement("button");
                        button.className = "btn btn-lg " + tab_names[i];
                        button.innerText = tab_names[i];
                        button.onclick = () => showMyTab(button);
                        tab_buttons.append(button);
                    }
                }
                else{
                    modalBody.innerHTML = "";
                    console.log(data);
                    [...Object.keys(data)].forEach(key => {
                        if(key != "header"){
                            modalBody.append(
                                createTab(
                                    key,
                                    data[key],
                                    key == "cadd" ? "block" : "none" 
                                )
                            )
                            let button = document.createElement("button");
                            button.className = "btn btn-lg " + key;
                            button.innerText = key;
                            button.onclick = () => showMyTab(button);
                            tab_buttons.append(button);
                        }
                    })
                    //modalBody.innerHTML = data["body"];
                }
                modal.style.display = "block";
                [...document.getElementsByClassName("page-link")]
                    .forEach(l => l.setAttribute("style","z-index: -1"))
            })
    }
</script>
<div id="myModal" class="modal"  style="display: none;">
    <div class="modal-content" id="modal-content">
        <div class="modal-header">
            <span class="close">&times;</span>
            <h2 id="modalHeader">Modal Header</h2>
        </div>
        <div id="tab_buttons"></div>
        <div class="modal-body" id="modalBody">
        </div>
    </div>
</div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th colspan="2">
                        <a href="javascript:toggleFilter()" id="fltr">
                            Filter >
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody id="filter" style="display: none;">
                <tr>
                    <td>Gene Name</td>
                    <td id="s0"></td>
                </tr>
                <tr>
                    <td>Biotype</td>
                    <td id="s1"></td>
                </tr>
                <tr>
                    <td>Contig</td>
                    <td id="s2"></td>
                </tr>
                <tr>
                    <td>Strand</td>
                    <td id="s3"></td>
                </tr>
            </tbody>
        </table>
        {{table|safe}}
{% endblock %}btn btn-outline-primary