{% extends "main.html" %}
{% block content %}
<script defer>
    var init = [];
    var expanded = false;
    var allData = {{allData|tojson}};
    var maintable = null;
    function showCheckboxes(select) {
        var checkboxes = select.nextElementSibling;
        if (!expanded) {
            checkboxes.style.display = "block";
            expanded = true;
        } else {
            checkboxes.style.display = "none";
            expanded = false;
        }
    }
    var selectedKeys = [];
    var allKeys = JSON.parse('{{allKeys|safe}}');
    function addOrRemoveKey(checkbox){
        if(checkbox.checked)
            selectedKeys.push(checkbox.id);
        else
            selectedKeys.remove(checkbox.id);
    }
    function resetSubkeys(mainKeys, checkbox){
        var subkeys = JSON.parse('{{subkeys|safe}}');
        let checkboxes = document.getElementById("checkboxes");
        checkboxes.innerHTML = "";
        let selectedText = mainKeys.getAttribute("for");
        [...mainKeys.parentElement.children]
            .forEach(child => {
                if(child.firstElementChild != checkbox){
                    child.firstElementChild.checked = false;
                }
            })
        for(let i = 0;i<subkeys[selectedText].length;i++){
            checkboxes.insertAdjacentHTML("beforeend",`
                <label for="${selectedText + "-" + subkeys[selectedText][i]}">
                    <input type="checkbox" id="${selectedText + "-" + subkeys[selectedText][i]}" onclick="changeSelectText(this.parentElement)" />
                    ${subkeys[selectedText][i].split("-")[0]}
                </label>
            `)
            if(selectedKeys.includes(checkboxes.lastElementChild.innerText) || !init.includes(selectedText))
                checkboxes.lastElementChild.firstElementChild.checked = true;
        }
        init.push(selectedText);
    }

    function changeSelectText(label){
        label.parentElement.previousElementSibling.firstElementChild.firstElementChild.innerText = label.innerText;
        if(label.firstElementChild.checked && !selectedKeys.includes(label.innerText)){
            selectedKeys.push(label.innerText);
            maintable.api().columns([parseInt(label.getAttribute("for").split("-")[2])]).visible(true);
        }
        else{
            selectedKeys = selectedKeys
                            .filter(key =>label.innerText != key);
            maintable.api().columns([parseInt(label.getAttribute("for").split("-")[2])]).visible(false);
        }
        //label.parentElement.style.display = "none";
        //expanded = false;
    }

    /*
    function showCheckBoxes(select){
        let mainKey = document.getElementById("mainkeys").value;
        let key = mainKey+"-"+select.value;
        let checkboxes = document.getElementById("checkboxes");
        Object.entries(allKeys[key])
            .forEach(entry => {
                entry[1].forEach(checkKey => {
                    let checkBox = document.createElement("input");
                    checkBox.type = "checkbox";
                    checkBox.id = checkKey;
                    checkboxes.append(checkBox);
                });
            });
    }
    */
    function generateDataTable(id,cols){
        $("#"+id).dataTable({
                  "orderable": false,
                  "columnDefs": [
                      {
                          "targets": cols,
                          "class":"none"
                      },
                      {
                          "aaSorting": false,
                          "targets": "_all",
                      },
                      {
                         "targets": [0],
                         "className": 'details-control',
                     }
                  ],
                  
                  "iDisplayLength": 2,
                  "aLengthMenu": [[2,5, 10, 25, 50, 100, -1], [2,5, 10, 25, 50, 100, "All"]],
                  "language": {
                      "paginate": {
                          "previous": "previous",
                          "next": "next"
                      }
                  },
                  responsive: true,
              })
    }

    function toNormalDataTable() {
        maintable = $("#table").dataTable({
             
        dom: 'lBfrtip',
             "orderable": false,
             
            buttons: [
            {
                extend: 'csv',
                exportOptions: {
                    columns: [ 1, 2, 3, 4,5,6,7]
                }
            },
            
            {
                extend: 'excel',
                exportOptions: {
                    columns: [ 1, 2, 3, 4,5,6,7]
                }
            },
            
            {
                extend: 'print',
                exportOptions: {
                    columns: [ 1, 2, 3, 4,5,6,7]
                }
            }
            ],
             "columnDefs": [
                 {
                     "targets": [],
                     "class":"none"
                 },
                 {
                     "orderable": false,
                     "aaSorting": false,
                     "targets": "_all",
                 },
                 {
                    "targets": [0],
                    "className": 'details-control',
                }
             ],
             
             "iDisplayLength": 2,
             "aLengthMenu": [[2,5, 10, 25, 50, 100, -1], [2,5, 10, 25, 50, 100, "All"]],
             "language": {
                 "paginate": {
                     "previous": "previous",
                     "next": "next"
                 }
             },
			 responsive: true,
             initComplete: function () {
                 this
                    .api().order( [ 1, 'asc' ] )
                    .draw();
                 [...document.getElementsByTagName("button")]
                    .filter(b => b.getAttribute("name") != "+")
                    .forEach(b => b.className += " btn btn-outline-primary");
                 let count = 0;
                 let cols = [4,5,6];
                 /* 
                 this.api().columns(cols).every(function () {
                     var column = this;
                     var select = $(`<select id="select${count}"><option value=""></option></select>`)
                         .appendTo($("#s"+String(count++)))
                         .on('change', function () {
                             var val = $.fn.dataTable.util.escapeRegex($(this).val());
                             column.search(val ? '^' + val + '$' : '', true, false).draw();
                         });
                     column.data().unique().sort().each(d => {
                            select.append('<option value="' + d + '">' + d + '</option>');
                     });
                 });
                 */
             }
         })

    }
    setTimeout(()=>toNormalDataTable(),2000);
    function toggleFilter(){
        let filterB = document.getElementById("fltr");
        if(filterB.innerText.includes(">")){
            document.getElementById("filter").style.display = "block";
            filterB.innerText = "Filter V";
        }
        else{
            document.getElementById("filter").style.display = "none";
            filterB.innerText = "Filter >";
        }
    }
    function toggle(btn){
        if(btn.innerText == "-") btn.innerText = "+";
        else btn.innerText = "-";
    }

    window.addEventListener("load",() => {
        var span = document.getElementsByClassName("close")[0];
        var modal = document.getElementById("myModal");
        span.onclick = function() {
            modal.style.display = "none";
            [...document.getElementsByTagName("select")]
                .forEach(select => select.selectedIndex = 0);
            [...document.getElementsByClassName("page-link")]
                .forEach(l => l.setAttribute("style","z-index: 1"))
            document.body.style.zoom = "100%";
        }
        window.onclick = event => {
            if (event.target == modal) {
                modal.style.display = "none";
                [...document.getElementsByClassName("page-link")]
                    .forEach(l => l.setAttribute("style","z-index: 1"))
                document.body.style.zoom = "100%";
            }
        }
    })

</script>
<form>
    <div class="multiselect">
      <div class="selectBox" onclick="showCheckboxes(this)">
        <select>
          <option>Select an option</option>
        </select>
        <div class="overSelect"></div>
      </div>
      <div id="checkboxes0" class="checkboxes">
        {{mainKeys|safe}}
      </div>
    </div>
  </form>
  <form>
      <div class="multiselect">
        <div class="selectBox" onclick="showCheckboxes(this)">
          <select>
            <option>Select an option</option>
          </select>
          <div class="overSelect"></div>
        </div>
        <div id="checkboxes" class="checkboxes">
        </div>
      </div>
    </form>
<div id="myModal" class="modal"  style="display: none;">
    <div class="modal-content" id="modal-content">
        <div class="modal-header">
            <span class="close">&times;</span>
            <h2 id="modalHeader">Modal Header</h2>
        </div>
        <button style="display: none;" id="back" onclick="showMainTabs(this)">Back</button>
        <div id="tab_buttons"></div>
        <div id="sub_tab_buttons"></div>
        <div class="modal-body" id="modalBody">
        </div>
    </div>
</div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th colspan="2">
                        <a href="javascript:toggleFilter()" id="fltr">
                            Filter >
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody id="filter" style="display: none;">
                <tr>
                    <td>Gene Name</td>
                    <td id="s0"></td>
                </tr>
                <tr>
                    <td>Biotype</td>
                    <td id="s1"></td>
                </tr>
                <tr>
                    <td>Contig</td>
                    <td id="s2"></td>
                </tr>
                <tr>
                    <td>Strand</td>
                    <td id="s3"></td>
                </tr>
            </tbody>
        </table>
        {{table|safe}}
{% endblock %}btn btn-outline-primary