{% extends "main.html" %}
{% block content %}
<script defer>
    var init = [];
    var subkeyinit = [];
    var subsubkeyinit = [];
    var expanded = false;
    var allData = {{allData|tojson}};
    var subkeys = JSON.parse('{{subkeys|safe}}');
    var defaults = ["Civic-Variants-CIViC: Civic Variant Evidence Score",
    "Civic-Clinical Evidences","Cosmic-CMC-COSMIC: GERP++ RS score",
    "Cosmic-CMC-COSMIC: Minimum SIFT score","Cosmic-CMC-COSMIC: Prediction corresponding to the minimum sift score",
    "Cadd-SIFTcat","Cadd-SIFTval","Cadd-PolyPhenCat","Cadd-PolyPhenVal","Cadd-GerpRS","Cadd-PHRED"
    ]
    var popupdata = {{popupdata|tojson}};

    var maintable = null;
    function showCheckboxes(select) {
        var checkboxes = select.nextElementSibling;
        if (!expanded) {
            checkboxes.style.display = "block";
            expanded = true;
        } else {
            checkboxes.style.display = "none";
            expanded = false;
        }
    }
    var selectedKeys = [];
    var allKeys = JSON.parse('{{allKeys|safe}}');
    function addOrRemoveKey(checkbox){
        if(checkbox.checked)
            selectedKeys.push(checkbox.id);
        else
            selectedKeys.remove(checkbox.id);
    }
    function resetSubkeys(mainKeys, checkbox){
        if(!checkbox.checked)
            return;
        document.getElementById("checkboxes1").innerHTML = ""; 
        var subkeys = JSON.parse('{{subkeys|safe}}');
        let checkboxes = document.getElementById("checkboxes");
        checkboxes.innerHTML = "";
        let selectedText = mainKeys.getAttribute("for");
        [...mainKeys.parentElement.children]
            .forEach(child => {
                if(child.firstElementChild != checkbox){
                    child.firstElementChild.checked = false;
                }
            })
        Object.keys(subkeys[selectedText])
            .forEach(subkey => {
                let index = "";
                let onchange = "resetSubSubKeys(this.parentElement, this)";
                if(typeof subkeys[selectedText][subkey] == "number"){
                    index = subkeys[selectedText][subkey];
                    onchange = "";
                }

                checkboxes.insertAdjacentHTML("beforeend",`
                    <label for="${selectedText + "-" + subkey + "-" + String(index)}">
                        <input type="checkbox" id="${selectedText + "-" + subkey + "-" + String(index)}" onclick="changeSelectText(this.parentElement)" onchange = "${onchange}" />
                        ${subkey}
                    </label>
                `);
                if(selectedKeys.includes(selectedText + "-" + subkey + "-" + String(index)) || (!subkeyinit.includes(selectedText) && defaults.includes(selectedText + "-" + subkey))){ 
                    checkboxes.lastElementChild.firstElementChild.checked = true;
                    if(!selectedKeys.includes(selectedText + "-" + subkey + "-" + String(index))){
                        selectedKeys.push(selectedText + "-" + subkey + "-" + String(index));
                    }
                }
            })
        /*
        Object.keys(subkeys)
            .forEach(mainkey => {
                Object.keys(subkeys[mainkey])
                    .forEach(subkey => {
                        if(typeof subkeys[mainkey][subkey] == 'number' && mainkey == selectedText){
                            maintable.api().columns([subkeys[mainkey][subkey]]).visible(true);
                        }
                        else{
                            Object.keys(subkeys[mainkey][subkey])
                                .forEach(subsubkey => {

                                })
                        }
                    })
            })
        */
        if(!init.includes(selectedText)){
            init.push(selectedText);
        }
        console.log(subkeys);
        checkboxes.style.display = "block";
        subkeyinit.push(selectedText);
    }

    function resetSubSubKeys(subKeys, checkbox){
        if(!checkbox.checked)
            return;
        let checkboxes = document.getElementById("checkboxes1");
        var subkeys = JSON.parse('{{subkeys|safe}}');
        checkboxes.innerHTML = "";
        let selectedText = subKeys.getAttribute("for");
        [...subKeys.parentElement.children]
            .forEach(child => {
                if(child.firstElementChild != checkbox){
                    child.firstElementChild.checked = false;
                }
            })
        let mainKey = selectedText.split("-")[0];
        let subkey = selectedText.split("-")[1];
        Object.keys(subkeys[mainKey][subkey])
            .forEach(subsubkey => {
                checkboxes.insertAdjacentHTML("beforeend",`
                    <label for="${selectedText + "-" + subsubkey + "-" + subkeys[mainKey][subkey][subsubkey]}">
                        <input type="checkbox" id="${selectedText + "-" + subsubkey + "-" + subkeys[mainKey][subkey][subsubkey]}" onclick="changeSelectText(this.parentElement)" />
                        ${subsubkey}
                    </label>
                `)
                if(selectedKeys.includes(selectedText + "-" + subsubkey + "-" + subkeys[mainKey][subkey][subsubkey]) || (defaults.includes(selectedText + subsubkey) && !subsubkeyinit.includes(selectedText))) checkboxes.lastElementChild.firstElementChild.checked = true;
            })
        if(!init.includes(selectedText)){
            init.push(selectedText);
        }
        checkboxes.style.display = "block";
        subsubkeyinit.push(selectedText);
    }

    function changeSelectText(label){
        label.parentElement.previousElementSibling.firstElementChild.firstElementChild.innerText = label.innerText;
        if(label.firstElementChild.checked && !selectedKeys.includes(label.innerText)){
            selectedKeys.push(label.getAttribute("for"));
            maintable.api().columns([parseInt(label.getAttribute("for").split("-").pop())]).visible(true);
        }
        else{
            selectedKeys = selectedKeys
                            .filter(key =>label.getAttribute("for") != key);
            maintable.api().columns([parseInt(label.getAttribute("for").split("-").pop())]).visible(false);
        }
        //label.parentElement.style.display = "none";
        //expanded = false;
    }

    /*
    function showCheckBoxes(select){
        let mainKey = document.getElementById("mainkeys").value;
        let key = mainKey+"-"+select.value;
        let checkboxes = document.getElementById("checkboxes");
        Object.entries(allKeys[key])
            .forEach(entry => {
                entry[1].forEach(checkKey => {
                    let checkBox = document.createElement("input");
                    checkBox.type = "checkbox";
                    checkBox.id = checkKey;
                    checkboxes.append(checkBox);
                });
            });
    }
    */
    function generateDataTable(id,cols){
        $("#"+id).dataTable({
                  "orderable": false,
                  "columnDefs": [
                      {
                          "targets": cols,
                          "class":"none"
                      },
                      {
                          "aaSorting": false,
                          "visible":false,
                          "targets": "_all",
                      },
                      {
                         "targets": [0],
                         "className": 'details-control',
                     }
                  ],
                  
                  "iDisplayLength": 2,
                  "aLengthMenu": [[2,5, 10, 25, 50, 100, -1], [2,5, 10, 25, 50, 100, "All"]],
                  "language": {
                      "paginate": {
                          "previous": "previous",
                          "next": "next"
                      }
                  },
                  responsive: true,
              })
    }

    function toNormalDataTable() {
        maintable = $("#table").dataTable({
             
        dom: 'lBfrtip',
             "orderable": false,
             
            buttons: [
            {
                extend: 'csv',
                exportOptions: {
                    columns: [ 1, 2, 3, 4,5,6,7]
                }
            },
            
            {
                extend: 'excel',
                exportOptions: {
                    columns: [ 1, 2, 3, 4,5,6,7]
                }
            },
            
            {
                extend: 'print',
                exportOptions: {
                    columns: [ 1, 2, 3, 4,5,6,7]
                }
            }
            ],
             "columnDefs": [
                 {
                     "targets": [],
                     "class":"none"
                 },
                 {
                     "orderable": false,
                     "aaSorting": false,
                     "visible":false,
                     "targets": "_all",
                 },
                 {
                    "targets": [0],
                    "className": 'details-control',
                }
             ],
             
             "iDisplayLength": 2,
             "aLengthMenu": [[2,5, 10, 25, 50, 100, -1], [2,5, 10, 25, 50, 100, "All"]],
             "language": {
                 "paginate": {
                     "previous": "previous",
                     "next": "next"
                 }
             },
			 responsive: true,
             initComplete: function () {
                 this
                    .api().order( [ 1, 'asc' ] )
                    .draw();
                 [...document.getElementsByTagName("button")]
                    .filter(b => b.getAttribute("name") != "+")
                    .forEach(b => b.className += " btn btn-outline-primary");
                 let count = 0;
                 let cols = [4,5,6];
                 /* 
                 this.api().columns(cols).every(function () {
                     var column = this;
                     var select = $(`<select id="select${count}"><option value=""></option></select>`)
                         .appendTo($("#s"+String(count++)))
                         .on('change', function () {
                             var val = $.fn.dataTable.util.escapeRegex($(this).val());
                             column.search(val ? '^' + val + '$' : '', true, false).draw();
                         });
                     column.data().unique().sort().each(d => {
                            select.append('<option value="' + d + '">' + d + '</option>');
                     });
                 });
                 */
             }
         })

    }
    function toggleFilter(){
        let filterB = document.getElementById("fltr");
        if(filterB.innerText.includes(">")){
            document.getElementById("filter").style.display = "block";
            filterB.innerText = "Filter V";
        }
        else{
            document.getElementById("filter").style.display = "none";
            filterB.innerText = "Filter >";
        }
    }
    function toggle(btn){
        if(btn.innerText == "-") btn.innerText = "+";
        else btn.innerText = "-";
    }

    window.addEventListener("load",() => {
        toNormalDataTable()
        var span = document.getElementsByClassName("close")[0];
        var modal = document.getElementById("myModal");
        span.onclick = function() {
            modal.style.display = "none";
            [...document.getElementsByTagName("select")]
                .forEach(select => select.selectedIndex = 0);
            [...document.getElementsByClassName("page-link")]
                .forEach(l => l.setAttribute("style","z-index: 1"))
            document.body.style.zoom = "100%";
        }
        window.onclick = event => {
            if (event.target == modal) {
                modal.style.display = "none";
                [...document.getElementsByClassName("page-link")]
                    .forEach(l => l.setAttribute("style","z-index: 1"))
                document.body.style.zoom = "100%";
            }
        }
        defaults.forEach(defaultt => {
            let parts = defaultt.split("-");
            let found = null;
            parts.forEach(part => {
                if(!found)
                    found = subkeys[part];
                else
                    found = found[part];
            });
            console.log(found);
            if(found)
                maintable.api().columns([found]).visible(true);
        });
    })
    function toggleModal(select){
        let header = select.value.split("-").pop();
        document.getElementById("modalHeader").innerText = header;
        document.getElementById("modalBody").innerHTML = popupdata[select.value];
        document.getElementById("myModal").style.display = "block";
    }

</script>
<form>
    <div class="multiselect">
      <div class="selectBox" onclick="showCheckboxes(this)">
        <select>
          <option>Select an option</option>
        </select>
        <div class="overSelect"></div>
      </div>
      <div id="checkboxes0" class="checkboxes">
        {{mainKeys|safe}}
      </div>
    </div>
  </form>
  <form>
      <div class="multiselect">
        <div class="selectBox" onclick="showCheckboxes(this)">
          <select>
            <option>Select an option</option>
          </select>
          <div class="overSelect"></div>
        </div>
        <div id="checkboxes" class="checkboxes">
        </div>
      </div>
    </form>
    <form>
        <div class="multiselect">
          <div class="selectBox" onclick="showCheckboxes(this)">
            <select>
              <option>Select an option</option>
            </select>
            <div class="overSelect"></div>
          </div>
          <div id="checkboxes1" class="checkboxes">
          </div>
        </div>
      </form>
<div id="myModal" class="modal"  style="display: none;">
    <div class="modal-content" id="modal-content">
        <div class="modal-header">
            <span class="close">&times;</span>
            <h2 id="modalHeader">Modal Header</h2>
        </div>
        <button style="display: none;" id="back" onclick="showMainTabs(this)">Back</button>
        <div id="tab_buttons"></div>
        <div id="sub_tab_buttons"></div>
        <div class="modal-body" id="modalBody">
        </div>
    </div>
</div>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th colspan="2">
                        <a href="javascript:toggleFilter()" id="fltr">
                            Filter >
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody id="filter" style="display: none;">
                <tr>
                    <td>Gene Name</td>
                    <td id="s0"></td>
                </tr>
                <tr>
                    <td>Biotype</td>
                    <td id="s1"></td>
                </tr>
                <tr>
                    <td>Contig</td>
                    <td id="s2"></td>
                </tr>
                <tr>
                    <td>Strand</td>
                    <td id="s3"></td>
                </tr>
            </tbody>
        </table>
        {{table|safe}}
{% endblock %}btn btn-outline-primary